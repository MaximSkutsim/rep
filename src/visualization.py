import numpy as np
import networkx as nx
import matplotlib.pyplot as plt
from sklearn.metrics.pairwise import cosine_similarity
from index_file import build_embedding_array

def build_similarity_graph(doc_embeddings_array, threshold=0.92):
    # Вычисляем косинусное сходство между всеми парами эмбеддингов
    cos_sims = cosine_similarity(doc_embeddings_array)

    G = nx.Graph()

    # Добавляем узлы в граф
    num_nodes = doc_embeddings_array.shape[0]
    G.add_nodes_from(range(num_nodes))

    # Добавляем ребра между узлами, если сходство выше порога
    for i in range(num_nodes):
        for j in range(i + 1, num_nodes):
            if cos_sims[i, j] >= threshold:
                G.add_edge(i, j, weight=cos_sims[i, j])

    return G


def visualize_graph(G):
    pos = nx.spring_layout(G)  # Расположение узлов
    plt.figure(figsize=(10, 10))
    plt.gca().set_facecolor("#292F33")

    # Рисуем узлы и ребра
    nx.draw_networkx_nodes(G, pos, node_size=500, node_color='#FF613A')
    nx.draw_networkx_edges(G, pos, width=1.0, alpha=0.5, edge_color='#FFFFFF')
    nx.draw_networkx_labels(G, pos, font_size=12, font_color="#292F33")

    plt.show()


notes = {
    "note1": {
        "title": "Основы кулинарии",
        "content": "Кулинария — это искусство приготовления пищи. Основные техники включают варку, жарку, тушение и запекание."
    },
    "note2": {
        "title": "История Древнего Египта",
        "content": "Древний Египет — одна из древнейших цивилизаций, известная своими пирамидами, иероглифами и фараонами."
    },
    "note3": {
        "title": "Основы фотографии",
        "content": "Фотография — это искусство захвата моментов на пленку или цифровой носитель. Основные параметры включают диафрагму, выдержку и ISO."
    },
    "note4": {
        "title": "Экология и окружающая среда",
        "content": "Экология изучает взаимодействие организмов с окружающей средой. Важные аспекты включают сохранение биоразнообразия и устойчивое развитие."
    },
    "note5": {
        "title": "Философия Древней Греции",
        "content": "Древняя Греция подарила миру множество философских школ и мыслителей, таких как Сократ, Платон и Аристотель."
    },
    "note6": {
        "title": "Основы йоги",
        "content": "Йога — это духовная и физическая практика, зародившаяся в Индии. Она включает асаны (позы), пранаяму (дыхательные техники) и медитацию."
    },
    "note7": {
        "title": "История архитектуры",
        "content": "Архитектура — это искусство проектирования и строительства зданий и сооружений. Известные стили включают готику, барокко и модерн."
    },
    "note8": {
        "title": "Основы астрономии",
        "content": "Астрономия — это наука о небесных телах, включая звезды, планеты, галактики и черные дыры."
    },
    "note9": {
        "title": "Психология человеческого поведения",
        "content": "Психология изучает мышление, эмоции и поведение человека. Основные направления включают когнитивную психологию, социальную психологию и психоанализ."
    },
    "note10": {
        "title": "Основы музыкальной теории",
        "content": "Музыкальная теория изучает структуру и элементы музыки, такие как ноты, аккорды, мелодии и ритмы."
    },
    "note11": {
        "title": "Технологии в кулинарии",
        "content": "Современные технологии значительно упростили процесс приготовления пищи. Примеры включают использование мультиварки, пароварки и роботов-поваров."
    },
    "note12": {
        "title": "Архитектура Древнего Египта",
        "content": "Архитектура Древнего Египта характеризуется массивными пирамидами, храмовыми комплексами и дворцами, построенными из камня."
    },
    "note13": {
        "title": "Космология и астрономия",
        "content": "Космология — это раздел астрономии, изучающий Вселенную в целом. Она исследует ее происхождение, структуру и эволюцию."
    },
    "note14": {
        "title": "Музыкальные инструменты",
        "content": "Музыкальные инструменты играют ключевую роль в создании музыки. К основным группам относятся струнные, духовые, ударные и клавишные инструменты."
    },
    "note15": {
        "title": "Экологические проблемы",
        "content": "Современные экологические проблемы включают глобальное потепление, загрязнение воздуха и воды, вырубку лесов и исчезновение видов."
    },
    "note16": {
        "title": "Философия этики",
        "content": "Этика — это раздел философии, изучающий моральные принципы и ценности. Она исследует, что значит быть хорошим человеком и как действовать правильно."
    },
    "note17": {
        "title": "Йога и здоровье",
        "content": "Йога оказывает положительное влияние на физическое и психическое здоровье. Она помогает снизить стресс, улучшить гибкость и укрепить мышцы."
    },
    "note18": {
        "title": "Астрономические наблюдения",
        "content": "Астрономические наблюдения позволяют изучать небесные тела и явления. Для этого используются телескопы, космические аппараты и другие инструменты."
    },
    "note19": {
        "title": "Музыка и эмоции",
        "content": "Музыка способна вызывать широкий спектр эмоций у слушателей. Она может успокаивать, воодушевлять, умиротворять и даже вызывать тревогу."
    },
    "note20": {
        "title": "Психология и общество",
        "content": "Психология изучает влияние общества на поведение и мышление человека. Она исследует социальные нормы, роли и взаимодействия."
    }
}
doc_embeddings_array = build_embedding_array(notes= notes)


# Предполагается, что doc_embeddings_array уже создан с помощью функции build_embedding_array
G = build_similarity_graph(doc_embeddings_array, threshold=0.94)
visualize_graph(G)